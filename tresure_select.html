<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>宝箱報酬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      background: linear-gradient(to bottom, #fceabb, #f8b500);
      font-family: 'Arial', sans-serif;
      text-align: center;
      padding: 20px;
      margin: 0;
      box-sizing: border-box;
      overflow-x: hidden;
    }

    h2 {
      font-size: 2em;
      margin-bottom: 20px;
      color: #6b3e26;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .chest-container {
      display: flex;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
      margin-top: 20px;
      position: relative;
    }

    .chest {
      width: 30vw;
      max-width: 150px;
      cursor: pointer;
      transition: transform 0.3s ease;
      position: relative;
      z-index: 1;
    }

    .chest:hover {
      transform: scale(1.1) rotate(-3deg);
    }

    #card-display {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 10;
      display: none;
    }

    #card-display img {
      width: 220px;
      height: auto;
      border-radius: 10px;
    }
    #card-display button {
      position: absolute;
      bottom: 0;
      right: -100%;
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      background: #ff9800;
      color: white;
      border-radius: 8px;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
      cursor: pointer;
    }

    #card-display button:hover {
      background: #e68900;
    }


    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.8); }
      to { opacity: 1; transform: scale(1); }
    }

    button {
      margin-top: 20px;
      padding: 12px 24px;
      font-size: 16px;
      border: none;
      background: #ff9800;
      color: white;
      border-radius: 8px;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
      cursor: pointer;
    }

    button:hover {
      background: #e68900;
    }

    @media (orientation: landscape) {
      body {
        padding: 10px;
      }

      h2 {
        font-size: 2.2em;
      }

      .chest {
        width: 20vw;
      }
    }

    #overlay-bg {
      display: none;
      position: fixed;
      z-index: 5;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: url('sparkle.png') center center / cover no-repeat; /* キラキラ画像を使う */
      background-color: rgba(255, 255, 255, 0.4); /* 半透明白で演出 */
    }

  </style>
</head>
<body>
  <audio id="se-open" src="tresure_open.mp3" preload="auto"></audio>
  <audio id="bgm" src="tresure_slect_bgm.mp3" preload="auto" loop></audio>

  <h2>宝箱を選んでください</h2>
  <div class="chest-container">
    <img src="box_closed.png" class="chest" data-index="0">
    <img src="box_closed.png" class="chest" data-index="1">
    <img src="box_closed.png" class="chest" data-index="2">
  </div>

  <div id="card-display">
      <img id="reward-card" src="" alt="報酬カード">
    <button onclick="goToSelect()">つぎへ</button>
  </div>
  <div id="overlay-bg"></div>

<script>
  // const params = new URLSearchParams(location.search);
  // const stage = 1;
  const urlParams = new URLSearchParams(window.location.search);
  const stage = urlParams.get('stage'); 

  const cardPools = {
    1: ['images/card/1.png', 'images/card/2.png', 'images/card/3.png'],
    2: ['images/card/4.png', 'images/card/5.png', 'images/card/6.png'],
    3: ['images/card/7.png', 'images/card/8.png', 'images/card/9.png'],
    4: ['images/card/10.png', 'images/card/11.png', 'images/card/12.png'],
    5: ['images/card/13.png', 'images/card/14.png', 'images/card/15.png'],
    6: ['images/card/16.png', 'images/card/17.png', 'images/card/18.png'],
  };

  const selectedCards = cardPools[stage] || [];
  let chestClicked = false; // ← 追加：1回クリック済みかどうか

document.querySelectorAll('.chest').forEach(chest => {
  chest.addEventListener('click', () => {
    if (chestClicked) return;
    chestClicked = true;

    const random = Math.floor(Math.random() * selectedCards.length);
    const selectedCard = selectedCards[random];

    // オーバーレイ表示
    const overlay = document.getElementById("overlay-bg");
    overlay.style.display = "block";

    // カード表示
    const display = document.getElementById("card-display");
    const cardImg = document.getElementById("reward-card");

    cardImg.src = selectedCard;
    display.style.display = "block";
    display.style.zIndex = "10";

    // カード保存
    let owned = JSON.parse(localStorage.getItem("ownedCards") || "[]");
    if (!owned.includes(selectedCard)) {
      owned.push(selectedCard);
    }
    localStorage.setItem("ownedCards", JSON.stringify(owned));

    // カードをクリックすると select.html へ遷移
    cardImg.addEventListener("click", goToSelect);
  });
});

  function goToCollection() {
    location.href = "otakara.html";
  }
  function goToSelect() {
    location.href = "select.html";
  }


  // 効果音とBGM
const seOpen = document.getElementById("se-open");
const bgm = document.getElementById("bgm");

// ユーザーの操作後にBGM再生（自動再生制限対応）
window.addEventListener("click", () => {
  if (bgm.paused) {
    bgm.volume = 0.5;  // 音量は調整可能
    bgm.play().catch(e => console.log("BGM再生失敗:", e));
  }
}, { once: true });

document.querySelectorAll('.chest').forEach(chest => {
  chest.addEventListener('click', () => {
    if (chestClicked) return;
    chestClicked = true;

    // 効果音再生
    seOpen.currentTime = 0;
    seOpen.play().catch(e => console.log("効果音再生失敗:", e));

    const random = Math.floor(Math.random() * selectedCards.length);
    const selectedCard = selectedCards[random];

    // オーバーレイ表示
    const overlay = document.getElementById("overlay-bg");
    overlay.style.display = "block";

    // カード表示
    const display = document.getElementById("card-display");
    const cardImg = document.getElementById("reward-card");

    cardImg.src = selectedCard;
    display.style.display = "block";
    display.style.zIndex = "10";

    // カード保存
    let owned = JSON.parse(localStorage.getItem("ownedCards") || "[]");
    if (!owned.includes(selectedCard)) {
      owned.push(selectedCard);
    }
    localStorage.setItem("ownedCards", JSON.stringify(owned));

    // カードをクリックすると select.html へ遷移
    cardImg.addEventListener("click", goToSelect);
  });
});

</script>
</body>
</html>
